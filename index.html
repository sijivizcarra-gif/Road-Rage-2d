<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Road Rage 2D - Pro Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <!-- PWA CONFIGURATION -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#050505">

  <!-- iOS Support -->
  <link rel="apple-touch-icon" href="icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <style>
    :root {    
      --neon-yellow: #faff00;    
      --neon-blue: #00f2ff;    
      --neon-red: #ff3131;    
      --bg-dark: #050505;    
    }    
    html, body {    
      margin: 0; padding: 0; width: 100%; height: 100%;    
      background: var(--bg-dark);    
      overflow: hidden; touch-action: none;    
      font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;    
    }    
    body { display: flex; justify-content: center; align-items: center; }  
    
    canvas {    
      border-left: 4px solid #222;    
      border-right: 4px solid #222;    
      box-shadow: 0 0 50px rgba(0,0,0,1);    
      background: #111;    
    }    
  
    /* Modern HUD */    
    #hud {    
      position: absolute; top: 15px; left: 15px; z-index: 30;    
      color: white; pointer-events: none;    
    }    
    .stat-box { margin-bottom: 8px; }    
    #bestText { 
      font-size: 11px; 
      text-transform: uppercase; 
      letter-spacing: 1px; 
      opacity: 0.7; 
      margin-bottom: 2px;
    }    
    #scoreText { 
      font-size: 28px; 
      font-weight: 900; 
      color: var(--neon-yellow); 
      text-shadow: 0 0 8px rgba(250,255,0,0.5);
      line-height: 1;
    }    
    
    #powerContainer { margin-top: 10px; }    
    #powerBar {    
      width: 120px; 
      height: 4px; 
      background: rgba(255,255,255,0.1);    
      border-radius: 2px; 
      overflow: hidden; 
      border: 1px solid rgba(255,255,255,0.15);    
    }    
    #powerFill { 
      height: 100%; 
      width: 0%; 
      background: var(--neon-blue); 
      box-shadow: 0 0 6px var(--neon-blue); 
      transition: width 0.1s; 
    }    

    #powerText {    
      font-size: 11px; 
      color: var(--neon-blue); 
      margin-top: 4px; 
      text-transform: uppercase; 
      letter-spacing: 1px;    
    }    

    /* Professional Overlays */    
    .overlay {    
      position: absolute; 
      width: 350px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(10, 10, 10, 0.85);    
      backdrop-filter: blur(10px);    
      border: 1px solid rgba(255,255,255,0.1);    
      border-top: 5px solid var(--neon-yellow);    
      color: white; 
      padding: 40px; 
      text-align: center; 
      z-index: 100;    
      border-radius: 4px; 
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);    
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    h1 { font-size: 2.5rem; margin: 0 0 20px 0; letter-spacing: -1px; font-style: italic; }    
    p { line-height: 1.6; color: #aaa; margin-bottom: 30px; }    

    .btn-pro {    
      background: var(--neon-yellow); color: black; border: none;    
      padding: 18px; font-size: 16px; font-weight: bold;    
      text-transform: uppercase; letter-spacing: 2px; cursor: pointer;    
      width: 100%; transition: 0.3s; clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%);    
    }    
    .btn-pro:hover { transform: scale(1.05); background: white; }    

    #gameOverBox { 
      display: none; 
      flex-direction: column;
      border-top-color: var(--neon-red); 
    }
    

    .blink { animation: blink-anim 1s infinite; }    
    @keyframes blink-anim { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .final-score-label {
      text-transform: uppercase;
      font-size: 12px;
      letter-spacing: 2px;
      color: #888;
      margin-top: 20px;
    }

    .final-score-val {
      font-size: 48px;
      font-weight: 900;
      color: var(--neon-yellow);
      margin-bottom: 30px;
      text-shadow: 0 0 20px rgba(250,255,0,0.3);
    }

    /* Pause Button Styles */
    #pauseBtn {
      position: absolute;
      top: 15px;
      right: 15px;
      z-index: 30;
      background: transparent;
      border: none;
      color: var(--neon-blue);
      width: 50px;
      height: 50px;
      cursor: pointer;
      font-size: 0;
      display: none;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
      filter: drop-shadow(0 0 6px rgba(0, 242, 255, 0.5));
    }

    #pauseBtn:hover {
      transform: scale(1.1);
      filter: drop-shadow(0 0 12px rgba(0, 242, 255, 0.8));
    }

    #pauseBtn:active {
      transform: scale(0.95);
    }

    #pauseBtn svg {
      width: 100%;
      height: 100%;
    }

    .pause-icon {
      display: block;
    }

    .play-icon {
      display: none;
    }

    #pauseBtn.paused .pause-icon {
      display: none;
    }

    #pauseBtn.paused .play-icon {
      display: block;
    }

    /* Pause Menu Overlay */
    #pauseMenu {
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(5, 5, 5, 0.85);
      backdrop-filter: blur(10px);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 50;
    }

    .pause-title {
      font-size: 3.5rem;
      font-weight: 900;
      color: var(--neon-blue);
      margin-bottom: 40px;
      text-transform: uppercase;
      letter-spacing: 4px;
      text-shadow: 0 0 30px var(--neon-blue);
    }

    /* Countdown Overlay */
    #countdownOverlay {
      position: absolute;
      width: 100%;
      height: 100%;
      background: rgba(5, 5, 5, 0.9);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 60;
    }

    .countdown-number {
      font-size: 10rem;
      font-weight: 900;
      color: var(--neon-yellow);
      text-shadow: 0 0 40px var(--neon-yellow);
      animation: pulse 1s infinite;
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
    }

    .countdown-message {
      font-size: 1.5rem;
      color: white;
      margin-top: 30px;
      text-transform: uppercase;
      letter-spacing: 2px;
      opacity: 0.8;
    }

    /* Background Pause Indicator */
    .bg-pause-indicator {
      position: absolute;
      top: 60px;
      right: 15px;
      background: rgba(255, 100, 100, 0.2);
      color: var(--neon-red);
      padding: 4px 8px;
      border-radius: 3px;
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      display: none;
      z-index: 31;
      border: 1px solid rgba(255, 100, 100, 0.3);
    }

    /* Simple Top Messages */
    .top-message {
      position: absolute;
      top: 150px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 16px;
      font-weight: 500;
      text-align: center;
      color: white;
      z-index: 25;
      pointer-events: none;
      opacity: 0;
      transition: opacity 1s ease-in-out;
      text-shadow: 0 2px 4px rgba(0,0,0,0.5);
      max-width: 80%;
      line-height: 1.4;
    }

    /* Car Selection Styles */
    #carSelectBox {
      position: absolute;
      width: 420px;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(10, 10, 10, 0.85);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.1);
      border-top: 5px solid var(--neon-yellow);
      color: white;
      padding: 30px;
      text-align: center;
      z-index: 100;
      border-radius: 4px;
      box-shadow: 0 20px 50px rgba(0,0,0,0.5);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .car-select-title {
      font-size: 2rem;
      margin: 0 0 25px 0;
      letter-spacing: -1px;
      font-style: italic;
      color: var(--neon-yellow);
      text-transform: uppercase;
    }

    .car-select-subtitle {
      font-size: 14px;
      color: #aaa;
      margin-bottom: 30px;
      line-height: 1.5;
    }

    .car-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 15px;
      margin-bottom: 30px;
      width: 100%;
    }

    .car-option {
      background: rgba(30, 30, 30, 0.7);
      border: 2px solid rgba(255,255,255,0.1);
      border-radius: 8px;
      padding: 15px;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 140px;
    }

    .car-option:hover {
      background: rgba(50, 50, 50, 0.7);
      transform: translateY(-5px);
    }

    .car-option.selected {
      border-color: var(--neon-yellow);
      background: rgba(250, 255, 0, 0.1);
      box-shadow: 0 0 20px rgba(250, 255, 0, 0.3);
    }

    .car-option.locked {
      opacity: 0.5;
      cursor: not-allowed;
      position: relative;
    }

    .car-option.locked::after {
      content: "üîí";
      position: absolute;
      top: 10px;
      right: 10px;
      font-size: 16px;
    }

    .car-preview {
      width: 80px;
      height: 50px;
      object-fit: contain;
      margin-bottom: 10px;
      filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
    }

    .car-name {
      font-size: 12px;
      font-weight: bold;
      margin-bottom: 5px;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .car-stats {
      font-size: 10px;
      color: #aaa;
      display: flex;
      gap: 8px;
      margin-top: 5px;
    }

    .stat-item {
      display: flex;
      align-items: center;
      gap: 3px;
    }

    .car-unlock-req {
      font-size: 9px;
      color: var(--neon-yellow);
      margin-top: 8px;
      font-style: italic;
    }

    .car-nav {
      display: flex;
      gap: 15px;
      margin-top: 20px;
    }

    .nav-btn {
      background: rgba(255,255,255,0.1);
      border: none;
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      font-size: 20px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .nav-btn:hover {
      background: rgba(255,255,255,0.2);
      transform: scale(1.1);
    }

    .car-preview-container {
      width: 200px;
      height: 120px;
      background: rgba(20, 20, 20, 0.5);
      border-radius: 10px;
      margin: 20px 0;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid rgba(255,255,255,0.1);
    }

    .selected-car-preview {
      width: 160px;
      height: 100px;
      object-fit: contain;
      filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
    }

    /* Simplified car stats */
    .car-simple-stats {
      font-size: 11px;
      color: #aaa;
      margin-top: 5px;
      text-align: center;
    }

    /* Installation Progress Indicator */
    #installProgress {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 30px;
      border-radius: 10px;
      z-index: 1000;
      display: none;
      text-align: center;
      border: 2px solid var(--neon-yellow);
      min-width: 300px;
    }
    
    #installProgress h2 {
      color: var(--neon-yellow);
      margin-top: 0;
    }
    
    .progress-container {
      margin: 20px 0;
    }
    
    .progress-bar-bg {
      background: #333;
      height: 10px;
      border-radius: 5px;
      overflow: hidden;
    }
    
    .progress-bar-fill {
      height: 100%;
      background: var(--neon-blue);
      width: 0%;
      transition: width 0.3s;
    }
    
    .progress-text {
      margin-top: 10px;
      font-size: 14px;
      color: #aaa;
    }
    
    .asset-status {
      font-size: 12px;
      color: #888;
      margin-top: 15px;
    }

  </style>
</head>
<body>
  <!-- Installation Progress Overlay -->
  <div id="installProgress">
    <h2>üì¶ Installing Game</h2>
    <div class="progress-container">
      <div class="progress-bar-bg">
        <div id="progressBar" class="progress-bar-fill"></div>
      </div>
      <div id="progressText" class="progress-text">Downloading game assets...</div>
    </div>
    <div id="assetStatus" class="asset-status">Preparing offline content...</div>
  </div>

  <!-- Install Button -->
  <button id="installBtn" style="
    display: none;
    position: absolute;
    bottom: 20px;
    right: 20px;
    background: var(--neon-yellow);
    color: black;
    border: none;
    padding: 10px 15px;
    border-radius: 5px;
    font-weight: bold;
    cursor: pointer;
    z-index: 1000;
  " onclick="installGame()">üì≤ INSTALL (Includes Full Music Pack)</button>
  
  <div id="hud">
    <div class="stat-box">
      <div id="bestText">
        Top Record: 0
      </div>
      <div id="scoreText">
        0
      </div>
    </div>
    <div id="powerContainer">
      <div id="powerText"></div>
      <div id="powerBar">
        <div id="powerFill"></div>
      </div>
    </div>
  </div>
  
  <!-- Simple Top Message -->
  <div class="top-message" id="topMessage"></div>
  
  <!-- Background Pause Indicator -->
  <div class="bg-pause-indicator" id="bgPauseIndicator">
    Auto Pause
  </div>
  
  <!-- Pause Button -->
  <button id="pauseBtn" onclick="togglePause()">
    <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor">
      <rect x="6" y="4" width="4" height="16"></rect>
      <rect x="14" y="4" width="4" height="16"></rect>
    </svg>
    <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
      <polygon points="5,3 19,12 5,21"></polygon>
    </svg>
  </button>
  
  <!-- Pause Menu -->
  <div id="pauseMenu">
    <div class="pause-title">PAUSED</div>
    <button class="btn-pro" onclick="resumeGame()">RESUME</button>
    <button class="btn-pro" style="margin-top: 20px; background: rgba(255,255,255,0.1); color: white;" onclick="restartGame()">RESTART</button>
    <button class="btn-pro" style="margin-top: 20px; background: var(--neon-red);" onclick="quitToMenu()">QUIT</button>
  </div>
  
  <!-- Countdown Overlay -->
  <div id="countdownOverlay">
    <div class="countdown-number">3</div>
    <div class="countdown-message">Get Ready!</div>
  </div>
  
  <!-- Car Selection Box -->
  <div id="carSelectBox">
    <div class="car-select-title">SELECT YOUR RIDE</div>
    <div class="car-select-subtitle">Choose your vehicle and dominate the highway</div>
    
    <div class="car-preview-container">
      <img id="selectedCarPreview" class="selected-car-preview" src="" alt="Selected Car">
    </div>
    
    <div class="car-grid" id="carGrid">
      <!-- Car options will be dynamically generated here -->
    </div>
    
    <div class="car-nav">
      <button class="nav-btn" onclick="prevCarPage()">‚ùÆ</button>
      <button class="btn-pro" onclick="confirmCarSelection()" style="width: 200px;">SELECT & PLAY</button>
      <button class="nav-btn" onclick="nextCarPage()">‚ùØ</button>
    </div>
    
    <button class="btn-pro" style="margin-top: 15px; background: rgba(255,255,255,0.05);" onclick="backToMenu()">BACK TO MENU</button>
  </div>
  
  <canvas id="game" width="500" height="800"></canvas>
  
  <!-- Start Menu -->
  <div id="startBox" class="overlay">
    <h1>ROAD<br>
    <span style="color:var(--neon-yellow)">RAGE 2D</span></h1>
    <p>Master the highway. Avoid traffic.<br>
    Use power-ups to survive.</p>
    <button class="btn-pro" onclick="showCarSelection()">SELECT CAR</button>
    <button class="btn-pro" style="margin-top: 15px; background: rgba(255,255,255,0.05);" onclick="quickStart()">QUICK START</button>
  </div>
  
  <!-- Game Over Screen -->
  <div id="gameOverBox" class="overlay">
    <h1 style="color: var(--neon-red)">WASTED</h1>
    <div class="final-score-label">
      Distance Reached
    </div>
    <div id="finalScore" class="final-score-val">
      0
    </div>
    <button class="btn-pro blink" onclick="showCarSelection()">PLAY AGAIN</button>
    <button class="btn-pro" style="margin-top: 15px; background: rgba(255,255,255,0.05);" onclick="backToMenuFromGameOver()">MAIN MENU</button>
  </div>
  
  <script>
    // ===== GAME VARIABLES =====
    const canvas = document.getElementById("game");
    const ctx = canvas.getContext("2d");
    ctx.imageSmoothingEnabled = true;    
    
    // UI Elements
    const scoreText = document.getElementById("scoreText");    
    const bestText = document.getElementById("bestText");    
    const powerFill = document.getElementById("powerFill");    
    const powerText = document.getElementById("powerText");    
    const startBox = document.getElementById("startBox");    
    const gameOverBox = document.getElementById("gameOverBox");    
    const finalScore = document.getElementById("finalScore");    
    const pauseBtn = document.getElementById("pauseBtn");
    const pauseMenu = document.getElementById("pauseMenu");
    const countdownOverlay = document.getElementById("countdownOverlay");
    const countdownNumber = countdownOverlay.querySelector('.countdown-number');
    const bgPauseIndicator = document.getElementById("bgPauseIndicator");
    const topMessage = document.getElementById("topMessage");
    const carSelectBox = document.getElementById("carSelectBox");
    const carGrid = document.getElementById("carGrid");
    const selectedCarPreview = document.getElementById("selectedCarPreview");
    const installProgress = document.getElementById("installProgress");
    const progressBar = document.getElementById("progressBar");
    const progressText = document.getElementById("progressText");
    const assetStatus = document.getElementById("assetStatus");
    const installBtn = document.getElementById("installBtn");

    // Game Constants
    const W = 500, H = 800;    
    const LANES = [85, 165, 245, 325, 405];    
    const COLORS = ["#FF3131", "#00F2FF", "#FFCA3A", "#8AC926", "#6A4C93"];    
    
    // Game State Variables
    let car, enemies, roadLines, sideMarkers, speed, distance, score;
    let gameStarted = false, gameOver = false, moveDir = 0, spawnTimer = 0;    
    let powerState = null, powerTimer = 0, powerCooldown = 0, nextPowerScore = 500;    
    let scoreMultiplier = 1, powerMsg = "", powerMsgTimer = 0;      
    let baseDistance = 0;
    let slowMultiplier = 1;
    let originalSpeed = 4;
    let scoreDuring2X = 0;
    let gamePaused = false;
    let isCountdown = false;
    let autoPaused = false;
    let messageTimer = 0;
    let lastMessageTime = 0;
    let selectedCarIndex = 0;
    let currentCarPage = 0;
    let unlockedCars = [0];
    let highScore = Number(localStorage.getItem("rr_high_pro")) || 0;
    
    // Audio System Variables
    let bgAudios = [];
    let currentBG = null;
    let lastIndex = -1;
    let musicEnabled = true;
    let audioFullyCached = false;
    let cacheCheckInterval;

    // ===== OFFLINE AUDIO SYSTEM =====
    // FIXED: Use relative paths to match service worker
    const bgTracks = [
      "music/ms1.m4a",
      "music/ms2.m4a",
      "music/ms3.m4a",
      "music/ms4.m4a",
      "music/ms5.m4a"
    ];

    // Check if all audio files are cached
    async function verifyAudioCache() {
      if (!('caches' in window)) return false;
      
      try {
        const cache = await caches.open('road-rage-complete-v1.0');
        const keys = await cache.keys();
        
        // FIXED: Check for both absolute and relative paths
        const audioFiles = keys.filter(key => {
          const url = key.url.toLowerCase();
          return url.includes('.m4a') && (
            url.includes('music/ms1.m4a') ||
            url.includes('music/ms2.m4a') ||
            url.includes('music/ms3.m4a') ||
            url.includes('music/ms4.m4a') ||
            url.includes('music/ms5.m4a') ||
            url.includes('/road-rage-2d/music/')
          );
        });
        
        console.log(`üéµ Audio cache status: ${audioFiles.length}/5 files`);
        
        if (audioFiles.length >= 5) {
          audioFullyCached = true;
          return true;
        }
        
        return false;
      } catch (error) {
        console.error('Cache check failed:', error);
        return false;
      }
    }

    // Preload all audio files
    async function preloadAllAudio() {
      console.log('üîä Preloading all game audio...');
      
      for (const src of bgTracks) {
        try {
          await fetch(src, { cache: 'force-cache' });
          console.log(`‚úÖ Audio preloaded: ${src}`);
        } catch (error) {
          console.log(`‚ö†Ô∏è Could not preload: ${src}`, error);
        }
      }
      
      await new Promise(resolve => setTimeout(resolve, 1000));
      
      const cached = await verifyAudioCache();
      
      if (cached) {
        console.log('üéâ All audio files are cached and ready for offline!');
        showTopMessage('‚úÖ Full music pack ready for offline!');
        return true;
      } else {
        console.warn('‚ö†Ô∏è Some audio files may not work offline');
        return false;
      }
    }

    // Create offline-ready audio system
    function createAudioSystem() {
      console.log('üîß Creating offline-ready audio system...');
      
      bgAudios = bgTracks.map((src, index) => {
        const audio = new Audio();
        audio.src = src;
        audio.preload = "auto";
        audio.load();
        
        audio.addEventListener('canplaythrough', () => {
          console.log(`‚úÖ Audio ${index + 1} ready: ${src}`);
        });
        
        audio.addEventListener('error', (e) => {
          console.error(`‚ùå Audio ${index + 1} error:`, src, e);
          setTimeout(() => {
            audio.load();
          }, 1000);
        });
        
        audio.volume = 0.5;
        audio.setAttribute("playsinline", "");
        
        return audio;
      });
      
      console.log('üéµ Audio system created');
    }

    // Play music with retry logic
    function playRandomBG() {
      if (!musicEnabled || bgAudios.length === 0) return;
      
      let index;
      do {
        index = Math.floor(Math.random() * bgAudios.length);
      } while (index === lastIndex && bgAudios.length > 1);

      lastIndex = index;

      if (currentBG) {
        currentBG.pause();
        currentBG.currentTime = 0;
      }

      currentBG = bgAudios[index];
      
      const safePlay = (attempt = 1) => {
        const playPromise = currentBG.play();
        
        if (playPromise !== undefined) {
          playPromise
            .then(() => {
              console.log(`‚ñ∂Ô∏è Playing track ${index + 1}`);
            })
            .catch(error => {
              console.log(`‚è∏Ô∏è Play failed (attempt ${attempt}):`, error.message);
              
              if (attempt < 3) {
                setTimeout(() => safePlay(attempt + 1), 500);
              } else {
                console.log('üîá Giving up on this track');
                setTimeout(playRandomBG, 1000);
              }
            });
        }
      };

      safePlay();
      
      currentBG.onended = () => {
        if (musicEnabled) {
          setTimeout(playRandomBG, 1000);
        }
      };
    }

    function stopMusic() {
      musicEnabled = false;
      if (currentBG) {
        currentBG.pause();
        currentBG.currentTime = 0;
      }
    }

    // Cache status monitor
    function startCacheMonitor() {
      cacheCheckInterval = setInterval(() => {
        if (gameStarted && !audioFullyCached) {
          verifyAudioCache();
        }
      }, 10000);
      
      setTimeout(() => verifyAudioCache(), 2000);
    }

    function stopCacheMonitor() {
      if (cacheCheckInterval) {
        clearInterval(cacheCheckInterval);
      }
    }

    // ===== IMAGE PRELOADING =====
    function preloadImages(srcArray, callback) {
      let loaded = 0;
      const images = [];
      srcArray.forEach(src => {
        const img = new Image();
        img.src = src;
        img.onload = () => {
          loaded++;
          if (loaded === srcArray.length) callback(images);
        };
        images.push(img);
      });
    }

    // FIXED: Use relative paths for images too
    const imageSources = [
      "imahe/image2.png", 
      "imahe/image1.png",
      "imahe/image3.png",
      "imahe/image4.png",
      "imahe/image5.png",
      "imahe/image6.png",
      "imahe/image7.png",
      "imahe/image8.png",
      "imahe/image9.png"
    ];
    
    let playerImg, enemyImgs;

    preloadImages(imageSources, (loadedImages) => {
      playerImg = loadedImages[0];
      enemyImgs = loadedImages.slice(1);
      initGame();
      loop();
    });

    // ===== INPUT HANDLING =====
    let inputDir = 0;

    window.addEventListener("keydown", e => {
      if (e.key === "ArrowLeft" || e.key === "a") inputDir = -1;
      if (e.key === "ArrowRight" || e.key === "d") inputDir = 1;
      if (e.key === "Escape" || e.key === "p") togglePause();
    });

    window.addEventListener("keyup", e => {
      if (
        e.key === "ArrowLeft" || e.key === "a" ||
        e.key === "ArrowRight" || e.key === "d"
      ) inputDir = 0;
    });

    canvas.addEventListener("touchstart", e => {
      e.preventDefault();
      const x = e.touches[0].clientX;
      inputDir = x < window.innerWidth / 2 ? -1 : 1;
    }, { passive: false });

    canvas.addEventListener("touchend", () => inputDir = 0, { passive: false });

    canvas.addEventListener("mousedown", e => {
      const rect = canvas.getBoundingClientRect();
      const x = e.clientX - rect.left;
      inputDir = x < canvas.width / 2 ? -1 : 1;
    });

    window.addEventListener("mouseup", () => inputDir = 0);

    // ===== CAR DATABASE =====
    // FIXED: Use relative paths for car images
    const carDatabase = [
      {
        name: "Street Racer",
        image: "imahe/image2.png",
        speed: 7,
        handling: 8,
        acceleration: 9,
        description: "Balanced performance",
        unlocked: true,
        unlockRequirement: "Starting Car"
      },
      {
        name: "Speed Demon",
        image: "imahe/image1.png",
        speed: 9,
        handling: 6,
        acceleration: 8,
        description: "Extreme top speed",
        unlocked: false,
        unlockRequirement: "Reach 2000 points"
      },
      {
        name: "Drift King",
        image: "imahe/image3.png",
        speed: 6,
        handling: 10,
        acceleration: 7,
        description: "Perfect control",
        unlocked: false,
        unlockRequirement: "Reach 3000 points"
      },
      {
        name: "Muscle Car",
        image: "imahe/image4.png",
        speed: 8,
        handling: 5,
        acceleration: 10,
        description: "Rapid acceleration",
        unlocked: false,
        unlockRequirement: "Reach 4000 points"
      },
      {
        name: "Sports Classic",
        image: "imahe/image5.png",
        speed: 7,
        handling: 9,
        acceleration: 6,
        description: "Vintage style",
        unlocked: false,
        unlockRequirement: "Reach 5000 points"
      },
      {
        name: "Hyper Car",
        image: "imahe/image6.png",
        speed: 10,
        handling: 7,
        acceleration: 9,
        description: "Ultimate performance",
        unlocked: false,
        unlockRequirement: "Reach 10000 points"
      },
      {
        name: "Cyber Racer",
        image: "imahe/image7.png",
        speed: 8,
        handling: 8,
        acceleration: 8,
        description: "Futuristic tech",
        unlocked: false,
        unlockRequirement: "Beat high score"
      },
      {
        name: "Neon Cruiser",
        image: "imahe/image8.png",
        speed: 6,
        handling: 9,
        acceleration: 7,
        description: "Glow in the dark",
        unlocked: false,
        unlockRequirement: "Play 10 games"
      },
      {
        name: "Monster Truck",
        image: "imahe/image9.png",
        speed: 5,
        handling: 4,
        acceleration: 5,
        description: "Crush everything",
        unlocked: false,
        unlockRequirement: "Unlock all other cars"
      }
    ];

    // ===== GAME INITIALIZATION =====
    function initGame() {    
      car = { 
        x: 230,
        y: H - 150,
        w: 50,
        h: 90,
        img: playerImg,
        shield: false
      };
      
      enemies = []; 
      roadLines = []; 
      sideMarkers = [];    
      speed = 4; 
      distance = 0; 
      score = 0; 
      spawnTimer = 0;    
      powerState = null; 
      powerTimer = 0; 
      powerCooldown = 0; 
      nextPowerScore = 500;    
      scoreMultiplier = 1; 
      slowMultiplier = 1; 
      originalSpeed = 4;
      powerMsg = ""; 
      powerMsgTimer = 0; 
      gameOver = false;    
      baseDistance = 0;
      scoreDuring2X = 0;
      gamePaused = false;
      isCountdown = false;
      autoPaused = false;
      messageTimer = 0;
      lastMessageTime = 0;
      
      powerText.textContent = "";
      powerFill.style.width = "0%";
      powerFill.style.background = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();

      pauseMenu.style.display = "none";
      countdownOverlay.style.display = "none";
      bgPauseIndicator.style.display = "none";
      pauseBtn.style.display = "none";
      pauseBtn.classList.remove("paused");
      
      topMessage.style.opacity = "0";

      for (let i = 0; i < H; i += 80) {    
        roadLines.push({ y: i });    
        sideMarkers.push({ y: i });    
      }    
    }

    // ===== GAME START =====
    function startGame() {
      startBox.style.display = "none";
      gameOverBox.style.display = "none";
      carSelectBox.style.display = "none";
      initGame();
      gameStarted = true;
      pauseBtn.style.display = "flex";
      pauseBtn.classList.remove("paused");

      if (bgAudios.length === 0) {
        createAudioSystem();
      }
      
      setTimeout(() => {
        playRandomBG();
        
        verifyAudioCache().then(cached => {
          if (!cached) {
            showTopMessage('‚ö†Ô∏è Connect online once for full music pack');
          }
        });
        
        startCacheMonitor();
      }, 800);
    }

    // ===== GAME LOGIC =====
    function hit(a, b) {
      return a.x < b.x + b.w && 
             a.x + a.w > b.x && 
             a.y < b.y + b.h && 
             a.y + a.h > b.y;
    }

    function spawnEnemies() {
      let lanes = [...LANES];
      let count = Math.random() < 0.75 ? 1 : 2;
      
      for (let i = 0; i < count; i++) {
        if (lanes.length === 0) break;
        let idx = Math.floor(Math.random() * lanes.length);
        enemies.push({ 
          x: lanes.splice(idx, 1)[0],
          y: -120,
          w: 50,
          h: 90,
          img: enemyImgs[Math.floor(Math.random() * enemyImgs.length)]
        });
      }
    }

    // ===== DRAWING FUNCTIONS =====
    function drawPlayer(c) {
      ctx.save();
      ctx.shadowColor = "rgba(255,255,255,0.35)";
      ctx.shadowBlur = 18;

      if (c.img.complete) {
        ctx.drawImage(c.img, c.x, c.y, c.w, c.h);
      }

      ctx.restore();
    }

    function drawEnemy(e) {
      ctx.save();
      ctx.shadowColor = "rgba(255,255,255,0.25)";
      ctx.shadowBlur = 14;

      if (e.img.complete) {
        ctx.drawImage(e.img, e.x, e.y, e.w, e.h);
      }

      ctx.restore();
    }

    function drawPowerEffects() {
      if (!powerState) return;

      if (powerState === "SHIELD") {
        ctx.save();
        ctx.strokeStyle = car.shield ? "rgba(0, 255, 255, 0.7)" : "rgba(255, 100, 100, 0.5)";
        ctx.lineWidth = 4;
        ctx.shadowColor = car.shield ? "#00ffff" : "#ff6464";
        ctx.shadowBlur = car.shield ? 15 : 8;
        ctx.strokeRect(car.x - 6, car.y - 6, car.w + 12, car.h + 12);
        ctx.restore();
      }

      if (powerState === "SLOW") {
        ctx.save();
        ctx.strokeStyle = "rgba(100, 200, 255, 0.6)";
        for (let i = 0; i < 3; i++) {
          ctx.strokeRect(
            car.x - 10 - i * 6,
            car.y - 10 - i * 6,
            car.w + 20 + i * 12,
            car.h + 20 + i * 12
          );
        }
        ctx.restore();
      }

      if (powerState === "2X") {
        ctx.save();
        ctx.fillStyle = "rgba(255, 215, 0, 0.15)";
        ctx.shadowColor = "#ffd700";
        ctx.shadowBlur = 20;
        ctx.fillRect(car.x - 8, car.y - 8, car.w + 16, car.h + 16);
        ctx.restore();
      }
    }

    function activatePower() {
      const powers = ["SHIELD", "SLOW", "2X"];    
      powerState = powers[Math.floor(Math.random() * 3)];    
      powerTimer = 300;
      powerCooldown = 900;
      powerText.textContent = "POWER: " + powerState;    
      powerMsg = powerState + " POWER!"; 
      powerMsgTimer = 60;    
      
      if (powerState === "SHIELD") {
        car.shield = true;
      }
      
      if (powerState === "SLOW") {
        slowMultiplier = 0.6;
        originalSpeed = speed;
      }
      
      if (powerState === "2X") {
        scoreMultiplier = 2;
        baseDistance = distance;
        scoreDuring2X = score;
      }
    }

    // ===== CAR SELECTION SYSTEM =====
    function showCarSelection() {
      startBox.style.display = "none";
      gameOverBox.style.display = "none";
      updateUnlockedCars();
      renderCarSelection();
      carSelectBox.style.display = "flex";
    }
    
    function updateUnlockedCars() {
      const savedUnlocked = localStorage.getItem("rr_unlocked_cars");
      if (savedUnlocked) {
        unlockedCars = JSON.parse(savedUnlocked);
      } else {
        unlockedCars = [0];
        localStorage.setItem("rr_unlocked_cars", JSON.stringify(unlockedCars));
      }
      
      const checkpoints = [2000, 3000, 4000, 5000, 10000];
      checkpoints.forEach((checkpoint, index) => {
        if (highScore >= checkpoint && !unlockedCars.includes(index + 1)) {
          unlockedCars.push(index + 1);
        }
      });
      
      localStorage.setItem("rr_unlocked_cars", JSON.stringify(unlockedCars));
      
      carDatabase.forEach((car, index) => {
        car.unlocked = unlockedCars.includes(index);
      });
    }
    
    function renderCarSelection() {
      carGrid.innerHTML = '';
      const carsPerPage = 6;
      const startIndex = currentCarPage * carsPerPage;
      const endIndex = Math.min(startIndex + carsPerPage, carDatabase.length);
      
      for (let i = startIndex; i < endIndex; i++) {
        const carData = carDatabase[i];
        const carOption = document.createElement('div');
        carOption.className = `car-option ${carData.unlocked ? '' : 'locked'} ${i === selectedCarIndex ? 'selected' : ''}`;
        carOption.onclick = () => selectCar(i);
        
        carOption.innerHTML = `
          <img src="${carData.image}" class="car-preview" alt="${carData.name}">
          <div class="car-name">${carData.name}</div>
          <div class="car-simple-stats">
            Speed: ${carData.speed}/10<br>
            ${carData.description}
          </div>
          ${!carData.unlocked ? `<div class="car-unlock-req">${carData.unlockRequirement}</div>` : ''}
        `;
        
        carGrid.appendChild(carOption);
      }
      
      const selectedCar = carDatabase[selectedCarIndex];
      selectedCarPreview.src = selectedCar.image;
    }
    
    function selectCar(index) {
      const carData = carDatabase[index];
      if (!carData.unlocked) {
        showTopMessage("Locked! " + carData.unlockRequirement);
        return;
      }
      
      selectedCarIndex = index;
      renderCarSelection();
    }
    
    function prevCarPage() {
      if (currentCarPage > 0) {
        currentCarPage--;
        renderCarSelection();
      }
    }
    
    function nextCarPage() {
      const totalPages = Math.ceil(carDatabase.length / 6);
      if (currentCarPage < totalPages - 1) {
        currentCarPage++;
        renderCarSelection();
      }
    }
    
    function confirmCarSelection() {
      const selectedCar = carDatabase[selectedCarIndex];
      if (!selectedCar.unlocked) {
        showTopMessage("This car is locked!");
        return;
      }
      
      const img = new Image();
      img.src = selectedCar.image;
      img.onload = () => {
        playerImg = img;
        startGame();
      };
      img.onerror = () => {
        startGame();
      };
    }
    
    function quickStart() {
      selectedCarIndex = 0;
      const img = new Image();
      img.src = carDatabase[0].image;
      img.onload = () => {
        playerImg = img;
        startGame();
      };
      img.onerror = () => {
        startGame();
      };
    }
    
    function backToMenu() {
      carSelectBox.style.display = "none";
      startBox.style.display = "flex";
    }
    
    function backToMenuFromGameOver() {
      gameOverBox.style.display = "none";
      startBox.style.display = "flex";
    }

    // ===== MESSAGE SYSTEM =====
    const simpleMessages = [
      "Miss mo na ba s'ya?",
      "What if mahal ka pa n'ya?",
      "I miss yoy",
      "Okay lang 'yan",
      "Kaya pa 'yan late game",
      "Balik ka na",
      "Don't give up!",
      "Sana ako na lang",
      "Mahal pa kita",
      "Akala mo mahal ka n'ya?",
      "Sana ikaw na lang no?",
      "Masarap ba na parang wala ka lang sa kanya?",
      "Kaya pa yan late game"
    ];

    function showTopMessage(message) {
      if (!gameStarted || gamePaused || isCountdown || gameOver) return;
      
      if (parseFloat(topMessage.style.opacity) > 0) return;
      
      topMessage.textContent = message;
      topMessage.style.opacity = "1";
      
      messageTimer = 120;
      lastMessageTime = score;
    }
    
    function updateTopMessage() {
      if (messageTimer > 0) {
        messageTimer--;
        
        if (messageTimer <= 40) {
          topMessage.style.opacity = (messageTimer / 40).toString();
        }
      }
    }
    
    function showRandomMessage() {
      if (!gameStarted || gamePaused || isCountdown || gameOver) return;
      
      if (parseFloat(topMessage.style.opacity) > 0) return;
      
      if (score - lastMessageTime > 500 && Math.random() < 0.002) {
        const randomIndex = Math.floor(Math.random() * simpleMessages.length);
        showTopMessage(simpleMessages[randomIndex]);
      }
      
      if (score > 0 && score % 1000 === 0 && score - lastMessageTime > 300) {
        showTopMessage(`${score} points! Awesome!`);
      }
      
      if (highScore > 0 && score > highScore - 200 && score < highScore) {
        if (score - lastMessageTime > 400) {
          showTopMessage("Almost beat your record!");
        }
      }
      
      if (powerMsgTimer === 59) {
        if (score - lastMessageTime > 300) {
          showTopMessage(" what if mahal ka pa n'ya? Power up boi!");
        }
      }
    }

    // ===== PAUSE/RESUME SYSTEM =====
    function togglePause() {
      if (!gameStarted || gameOver || isCountdown) return;
      
      if (!gamePaused) {
        pauseGame(false);
      } else {
        resumeGame();
      }
    }
    
    function pauseGame(isAutoPause) {
      if (gamePaused || !gameStarted || gameOver || isCountdown) return;
      
      gamePaused = true;
      autoPaused = isAutoPause;
      
      if (isAutoPause) {
        bgPauseIndicator.style.display = "block";
        pauseBtn.classList.add("paused");
      } else {
        pauseMenu.style.display = "flex";
        pauseBtn.classList.add("paused");
        bgPauseIndicator.style.display = "none";
      }
      
      if (currentBG) {
        currentBG.pause();
      }
      
      topMessage.style.opacity = "0";
    }
    
    function resumeGame() {
      if (!gamePaused) return;
      
      pauseMenu.style.display = "none";
      bgPauseIndicator.style.display = "none";
      
      startCountdown();
    }
    
    function startCountdown() {
      isCountdown = true;
      countdownOverlay.style.display = "flex";
      
      let count = 3;
      countdownNumber.textContent = count;
      
      const countdownInterval = setInterval(() => {
        count--;
        if (count > 0) {
          countdownNumber.textContent = count;
        } else {
          countdownNumber.textContent = "GO!";
          
          setTimeout(() => {
            clearInterval(countdownInterval);
            countdownOverlay.style.display = "none";
            gamePaused = false;
            isCountdown = false;
            autoPaused = false;
            pauseBtn.classList.remove("paused");
            
            if (currentBG && musicEnabled) {
              currentBG.play().catch(() => {
                musicEnabled = false;
              });
            }
          }, 1000);
        }
      }, 1000);
    }
    
    function restartGame() {
      pauseMenu.style.display = "none";
      bgPauseIndicator.style.display = "none";
      gamePaused = false;
      autoPaused = false;
      pauseBtn.classList.remove("paused");
      
      const img = new Image();
      img.src = carDatabase[selectedCarIndex].image;
      img.onload = () => {
        playerImg = img;
        startGame();
      };
      img.onerror = () => {
        startGame();
      };
    }
    
    function quitToMenu() {
      pauseMenu.style.display = "none";
      bgPauseIndicator.style.display = "none";
      gamePaused = false;
      gameStarted = false;
      autoPaused = false;
      pauseBtn.style.display = "none";
      pauseBtn.classList.remove("paused");
      
      showCarSelection();
      stopMusic();
      stopCacheMonitor();
    }

    // ===== PAGE VISIBILITY =====
    function handleVisibilityChange() {
      if (document.hidden) {
        if (gameStarted && !gameOver && !gamePaused && !isCountdown) {
          pauseGame(true);
        }
        if (currentBG) {
          currentBG.pause();
        }
      }
    }
    
    document.addEventListener("visibilitychange", handleVisibilityChange);

    // ===== MAIN GAME LOOP =====
    function loop() {    
      ctx.clearRect(0, 0, W, H);
      ctx.fillStyle = "#141414";
      ctx.fillRect(50, 0, 400, H);

      roadLines.forEach(l => { 
        l.y += speed; 
        if (l.y > H) l.y = -80; 
        ctx.fillStyle = "#bbb"; 
        ctx.fillRect(W/2 - 5, l.y, 10, 40); 
      });    
      
      sideMarkers.forEach(s => { 
        s.y += speed; 
        if (s.y > H) s.y = -80; 
        ctx.fillStyle = "#444"; 
        ctx.fillRect(50, s.y, 2, 40); 
        ctx.fillRect(448, s.y, 2, 40); 
      });    
      
      ctx.fillStyle = "rgba(255,255,255,0.08)";
      ctx.fillRect(50, 0, 400, H);

      if (gameStarted && !gameOver && !gamePaused && !isCountdown) {    
        updateTopMessage();
        showRandomMessage();
        
        if (powerTimer > 0) {
          powerTimer--;
          powerFill.style.width = (powerTimer / 300 * 100) + "%";
          powerFill.style.background = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();
          
          if (powerTimer <= 0) {
            if (powerState === "SHIELD") car.shield = false;
            if (powerState === "SLOW") {
              slowMultiplier = 1;
            }
            if (powerState === "2X") {
              scoreMultiplier = 1;
              if (score > distance) {
                distance = score;
              }
            }
            
            powerState = null;
            powerText.textContent = "";
            powerFill.style.width = "0%";
            powerFill.style.background = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();
          }
        }
        
        if (powerState === null && powerCooldown > 0) {
          powerCooldown--;
          let cooldownPercent = Math.max(0, ((900 - powerCooldown) / 900) * 100);
          powerFill.style.width = cooldownPercent + "%";
          powerFill.style.background = "#666";
          
          if (powerCooldown <= 0) {
            powerFill.style.width = "0%";
            powerFill.style.background = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();
          }
        }
        
        let dir = inputDir;    
        car.x += dir * 7;
        car.x = Math.max(60, Math.min(car.x, 440 - car.w));

        let distanceGained = speed / 12;
        distance += distanceGained;
        
        if (powerState === "2X") {
          let newDistance = distance - baseDistance;
          score = Math.floor(baseDistance + (newDistance * 2));
        } else {
          score = Math.max(score, Math.floor(distance));
        }
        
        scoreText.textContent = score;
        bestText.textContent = "Top Record: " + highScore;
        
        let level = Math.floor(score / 1000);
        let baseSpeed = 4;
        let levelSpeed = level * 0.6;
        let smoothSpeed = distance / 600;
        let calculatedSpeed = Math.min(10, baseSpeed + levelSpeed + smoothSpeed);
        
        const selectedCar = carDatabase[selectedCarIndex];
        let carSpeedBonus = (selectedCar.speed - 7) * 0.1;
        let carHandlingBonus = (selectedCar.handling - 8) * 0.05;
        
        if (powerState === "SLOW" && powerTimer > 0) {
          speed = calculatedSpeed * slowMultiplier * (1 + carSpeedBonus);
        } else {
          speed = calculatedSpeed * (1 + carSpeedBonus);
        }
        
        car.x += dir * (7 + carHandlingBonus * 2);

        if (score >= nextPowerScore && powerState === null && powerCooldown <= 0) { 
          activatePower(); 
          nextPowerScore = score + 400;
        }    

        spawnTimer++;
        
        if (spawnTimer > Math.max(80, 140 - distance / 10)) {
          spawnEnemies(); 
          spawnTimer = 0; 
        }

        enemies.forEach((e, i) => {  
          e.y += speed;
          drawEnemy(e);  
          
          if (hit(car, e)) {    
            if (powerState === "SHIELD" && car.shield && powerTimer > 0) {
              e.y = H + 200;
              powerTimer = Math.max(0, powerTimer - 50);
              car.shield = false;
              powerText.textContent = "POWER: SHIELD (USED)";
            } else {    
              gameOver = true;
              stopMusic();
              stopCacheMonitor();
              
              if (score > highScore) { 
                highScore = score; 
                localStorage.setItem("rr_high_pro", score); 
                bestText.textContent = "Top Record: " + score; 
              }    
              
              updateUnlockedCars();
              
              finalScore.textContent = score; 
              gameOverBox.style.display = "flex";
              pauseBtn.style.display = "none";
              bgPauseIndicator.style.display = "none";
            }    
          }  
        });  
        
        enemies = enemies.filter(e => e.y < H + 120);

        drawPlayer(car); 
        drawPowerEffects();  

        if (powerMsgTimer > 0) {    
          ctx.save(); 
          ctx.globalAlpha = powerMsgTimer / 60; 
          ctx.fillStyle = "#00ffff";
          ctx.font = "bold 28px Courier";
          ctx.textAlign = "center"; 
          ctx.fillText(powerMsg, W / 2, H / 2 - 40); 
          ctx.restore(); 
          powerMsgTimer--;    
        }
        
        if (powerState === "SLOW" && powerTimer > 0) {
          ctx.save();
          ctx.globalAlpha = 0.3;
          ctx.fillStyle = "#00aaff";
          ctx.font = "bold 20px sans-serif";
          ctx.textAlign = "center";
          ctx.fillText("SLOW", W / 2, 40);
          ctx.restore();
        }
        
        if (powerState === "2X" && powerTimer > 0) {
          ctx.save();
          ctx.globalAlpha = 0.3;
          ctx.fillStyle = "#ffd700";
          ctx.font = "bold 20px sans-serif";
          ctx.textAlign = "center";
          ctx.fillText("2X SCORE MULTIPLIER", W / 2, 40);
          ctx.restore();
        }
        
        ctx.save();
        ctx.globalAlpha = 0.5;
        ctx.fillStyle = "#fff";
        ctx.font = "12px sans-serif";
        ctx.textAlign = "left";
        ctx.fillText(`Speed: ${speed.toFixed(1)} | Car: ${carDatabase[selectedCarIndex].name}`, 20, H - 20);
        ctx.restore();
      } else if (!gameOver) {
        powerText.textContent = "";
        powerFill.style.width = "0%";
        powerFill.style.background = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();
      }
      
      requestAnimationFrame(loop);    
    }

    // ===== PWA INSTALLATION SYSTEM =====
    let deferredPrompt;

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      
      if (installBtn) {
        installBtn.style.display = 'block';
        installBtn.textContent = 'üì≤ INSTALL (Includes Full Music Pack)';
        
        verifyAudioCache().then(cached => {
          if (cached) {
            installBtn.title = 'Full game with music ready for offline';
          } else {
            installBtn.title = 'Install now - music will download in background';
          }
        });
        
        setTimeout(() => {
          installBtn.style.display = 'none';
        }, 30000);
      }
    });

    function installGame() {
      if (!deferredPrompt) {
        alert("Installation not available or already installed");
        return;
      }
      
      if (installProgress) {
        installProgress.style.display = 'block';
        progressText.textContent = 'Starting installation...';
      }
      
      deferredPrompt.prompt();
      
      deferredPrompt.userChoice.then(choiceResult => {
        if (choiceResult.outcome === 'accepted') {
          console.log('‚úÖ User installed Road Rage 2D');
          
          if ('serviceWorker' in navigator) {
            navigator.serviceWorker.ready.then(registration => {
              registration.update();
            });
          }
          
          setTimeout(() => {
            preloadAllAudio();
            startCacheMonitor();
          }, 2000);
          
          showTopMessage('üéÆ Game Installed! Works 100% offline.');
        }
        
        deferredPrompt = null;
        
        if (installBtn) installBtn.style.display = 'none';
        if (installProgress) installProgress.style.display = 'none';
      });
    }

    // ===== SERVICE WORKER PROGRESS MONITOR =====
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.addEventListener('message', event => {
        if (event.data.type === 'CACHE_PROGRESS') {
          if (installProgress.style.display === 'none') {
            installProgress.style.display = 'block';
          }
          
          progressBar.style.width = `${event.data.progress}%`;
          progressText.textContent = `Downloading: ${event.data.downloaded}/${event.data.total} files`;
          assetStatus.textContent = `Current: ${event.data.current.split('/').pop()}`;
          
          if (event.data.progress >= 100) {
            setTimeout(() => {
              installProgress.style.display = 'none';
              showTopMessage('‚úÖ Game fully installed! Works offline.');
              audioFullyCached = true;
            }, 1000);
          }
        }
      });
    }

    // ===== SERVICE WORKER REGISTRATION =====
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('./service-worker.js')
          .then(registration => {
            console.log('‚úÖ Service Worker registered for offline play:', registration.scope);
            
            registration.update();
            
            caches.open('road-rage-complete-v1.0').then(cache => {
              cache.keys().then(keys => {
                console.log(`üì¶ ${keys.length} game files cached for offline play`);
                
                if (keys.length > 10) {
                  setTimeout(() => {
                    showTopMessage('‚úÖ Game ready for offline play!');
                  }, 3000);
                }
              });
            });
          })
          .catch(err => {
            console.log('‚ùå Service Worker registration failed:', err);
          });
      });
    }

    // ===== ONLINE/OFFLINE DETECTION =====
    window.addEventListener('online', () => {
      console.log('üîµ Back online');
      showTopMessage('‚úÖ Back online - game synced');
    });

    window.addEventListener('offline', () => {
      console.log('‚ö´ Went offline');
      showTopMessage('‚ö´ Offline mode - all good!');
    });

    if (!navigator.onLine) {
      showTopMessage('‚ö´ Playing offline - all features available');
    }

    // Prevent touch scrolling
    document.addEventListener("touchmove", e => {
      e.preventDefault();
    }, { passive: false });

    // Initialize audio on first user interaction
    document.addEventListener('click', () => {
      if (bgAudios.length === 0) {
        createAudioSystem();
      }
    }, { once: true });

    document.addEventListener('touchstart', () => {
      if (bgAudios.length === 0) {
        createAudioSystem();
      }
    }, { once: true });

    // ===== INITIAL CACHE CHECK =====
    window.addEventListener('load', () => {
      // Check initial cache status
      setTimeout(() => {
        verifyAudioCache().then(cached => {
          if (cached) {
            console.log('‚úÖ Game is fully cached for offline play');
          } else if (navigator.onLine) {
            console.log('üåê Online - game will cache in background');
          } else {
            console.log('üì¥ Offline - some features may not work');
          }
        });
      }, 1000);
    });

  </script>
</body>
  </html>
