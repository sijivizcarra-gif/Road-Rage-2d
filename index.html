<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Road Rage 2D - Pro Edition</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  
  <!-- PWA CONFIGURATION -->
  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#050505">
  
  <!-- iOS Support -->
  <link rel="apple-touch-icon" href="./icons/icon-192.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Road Rage 2D">
  
  <style>
    :root {    
        --neon-yellow: #faff00;    
        --neon-blue: #00f2ff;    
        --neon-red: #ff3131;    
        --bg-dark: #050505;    
    }    
    html, body {    
        margin: 0; padding: 0; width: 100%; height: 100%;    
        background: var(--bg-dark);    
        overflow: hidden; touch-action: none;    
        font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;    
        display: flex;
        justify-content: center;
        align-items: center;
    }    
    
    #gameContainer {
        position: relative;
        width: 100%;
        height: 100%;
        max-width: 500px;
        max-height: 800px;
        overflow: hidden;
    }
    
    canvas {    
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #111;    
        display: block;
        image-rendering: -webkit-optimize-contrast;
        image-rendering: crisp-edges;
        image-rendering: pixelated;
    }    
    
    #hud {    
        position: absolute; 
        top: 15px; 
        left: 15px; 
        z-index: 30;    
        color: white; 
        pointer-events: none;    
    }    
    .stat-box { margin-bottom: 8px; }    
    #bestText { 
        font-size: 11px; 
        text-transform: uppercase; 
        letter-spacing: 1px; 
        opacity: 0.7; 
        margin-bottom: 2px;
    }    
    #scoreText { 
        font-size: 28px; 
        font-weight: 900; 
        color: var(--neon-yellow); 
        text-shadow: 0 0 8px rgba(250,255,0,0.5);
        line-height: 1;
    }    
    
    #powerContainer { margin-top: 10px; }    
    #powerBar {    
        width: 120px; 
        height: 4px; 
        background: rgba(255,255,255,0.1);    
        border-radius: 2px; 
        overflow: hidden; 
        border: 1px solid rgba(255,255,255,0.15);    
    }    
    #powerFill { 
        height: 100%; 
        width: 0%; 
        background: var(--neon-blue); 
        box-shadow: 0 0 6px var(--neon-blue); 
        transition: width 0.1s; 
    }    
    #powerText {    
        font-size: 11px; 
        color: var(--neon-blue); 
        margin-top: 4px; 
        text-transform: uppercase; 
        letter-spacing: 1px;    
    }    

    .overlay {    
        position: absolute; 
        width: 90%;
        max-width: 350px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(10, 10, 10, 0.95);    
        backdrop-filter: blur(10px);    
        border: 1px solid rgba(255,255,255,0.1);    
        border-top: 5px solid var(--neon-yellow);    
        color: white; 
        padding: 30px 20px; 
        text-align: center; 
        z-index: 100;    
        border-radius: 4px; 
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);    
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
    }

    h1 { 
        font-size: clamp(1.8rem, 5vw, 2.5rem); 
        margin: 0 0 20px 0; 
        letter-spacing: -1px; 
        font-style: italic; 
    }    
    p { 
        line-height: 1.6; 
        color: #aaa; 
        margin-bottom: 30px; 
        font-size: clamp(14px, 3vw, 16px);
    }    

    .btn-pro {    
        background: var(--neon-yellow); 
        color: black; 
        border: none;    
        padding: 15px; 
        font-size: clamp(14px, 3vw, 16px); 
        font-weight: bold;    
        text-transform: uppercase; 
        letter-spacing: 2px; 
        cursor: pointer;    
        width: 100%; 
        max-width: 300px;
        transition: 0.3s; 
        clip-path: polygon(0 0, 100% 0, 95% 100%, 5% 100%);    
        box-sizing: border-box;
    }    
    .btn-pro:hover { transform: scale(1.05); background: white; }    

    #gameOverBox { 
        display: none; 
        flex-direction: column;
        border-top-color: var(--neon-red); 
    }
    
    .blink { animation: blink-anim 1s infinite; }    
    @keyframes blink-anim { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    
    .final-score-label {
        text-transform: uppercase;
        font-size: clamp(11px, 2.5vw, 12px);
        letter-spacing: 2px;
        color: #888;
        margin-top: 20px;
    }

    .final-score-val {
        font-size: clamp(2rem, 10vw, 3rem);
        font-weight: 900;
        color: var(--neon-yellow);
        margin-bottom: 30px;
        text-shadow: 0 0 20px rgba(250,255,0,0.3);
    }

    #pauseBtn {
        position: absolute;
        top: 15px;
        right: 15px;
        z-index: 30;
        background: transparent;
        border: none;
        color: var(--neon-blue);
        width: 40px;
        height: 40px;
        cursor: pointer;
        font-size: 0;
        display: none;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        filter: drop-shadow(0 0 6px rgba(0, 242, 255, 0.5));
    }

    #pauseBtn:hover { transform: scale(1.1); }
    #pauseBtn:active { transform: scale(0.95); }
    #pauseBtn svg { width: 100%; height: 100%; }
    .pause-icon { display: block; }
    .play-icon { display: none; }
    #pauseBtn.paused .pause-icon { display: none; }
    #pauseBtn.paused .play-icon { display: block; }

    #pauseMenu {
        position: absolute;
        width: 100%;
        height: 100%;
        background: rgba(5, 5, 5, 0.95);
        backdrop-filter: blur(10px);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 50;
    }

    .pause-title {
        font-size: clamp(2rem, 8vw, 3.5rem);
        font-weight: 900;
        color: var(--neon-blue);
        margin-bottom: 30px;
        text-transform: uppercase;
        letter-spacing: 3px;
        text-shadow: 0 0 30px var(--neon-blue);
        text-align: center;
    }

    #countdownOverlay {
        position: absolute;
        width: 100%;
        height: 100%;
        background: rgba(5, 5, 5, 0.95);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 60;
    }

    .countdown-number {
        font-size: clamp(5rem, 20vw, 10rem);
        font-weight: 900;
        color: var(--neon-yellow);
        text-shadow: 0 0 40px var(--neon-yellow);
        animation: pulse 1s infinite;
    }

    @keyframes pulse {
        0%, 100% { transform: scale(1); opacity: 1; }
        50% { transform: scale(1.2); opacity: 0.8; }
    }

    .countdown-message {
        font-size: clamp(1rem, 4vw, 1.5rem);
        color: white;
        margin-top: 20px;
        text-transform: uppercase;
        letter-spacing: 2px;
        opacity: 0.8;
        text-align: center;
    }

    .bg-pause-indicator {
        position: absolute;
        top: 60px;
        right: 15px;
        background: rgba(255, 100, 100, 0.2);
        color: var(--neon-red);
        padding: 4px 8px;
        border-radius: 3px;
        font-size: 10px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        display: none;
        z-index: 31;
        border: 1px solid rgba(255, 100, 100, 0.3);
    }

    .top-message {
        position: absolute;
        top: 150px;
        left: 50%;
        transform: translateX(-50%);
        font-size: clamp(14px, 4vw, 16px);
        font-weight: 500;
        text-align: center;
        color: white;
        z-index: 25;
        pointer-events: none;
        opacity: 0;
        transition: opacity 1 ease-in-out;
        text-shadow: 0 2px 4px rgba(0,0,0,0.5);
        width: 90%;
        max-width: 400px;
        line-height: 1.4;
    }

    #carSelectBox {
        position: absolute;
        width: 90%;
        max-width: 420px;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(10, 10, 10, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255,255,255,0.1);
        border-top: 5px solid var(--neon-yellow);
        color: white;
        padding: 25px 15px;
        text-align: center;
        z-index: 100;
        border-radius: 4px;
        box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        box-sizing: border-box;
    }

    .car-select-title {
        font-size: clamp(1.5rem, 5vw, 2rem);
        margin: 0 0 20px 0;
        letter-spacing: -1px;
        font-style: italic;
        color: var(--neon-yellow);
        text-transform: uppercase;
    }

    .car-select-subtitle {
        font-size: clamp(12px, 3vw, 14px);
        color: #aaa;
        margin-bottom: 25px;
        line-height: 1.5;
    }

    .car-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 10px;
        margin-bottom: 25px;
        width: 100%;
    }

    .car-option {
        background: rgba(30, 30, 30, 0.7);
        border: 2px solid rgba(255,255,255,0.1);
        border-radius: 6px;
        padding: 10px;
        cursor: pointer;
        transition: all 0.3s;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 120px;
        box-sizing: border-box;
    }

    .car-option:hover { background: rgba(50, 50, 50, 0.7); transform: translateY(-5px); }
    .car-option.selected { border-color: var(--neon-yellow); background: rgba(250, 255, 0, 0.1); box-shadow: 0 0 20px rgba(250, 255, 0, 0.3); }
    .car-option.locked { opacity: 0.5; cursor: not-allowed; position: relative; }
    .car-option.locked::after { content: "üîí"; position: absolute; top: 8px; right: 8px; font-size: 14px; }

    .car-preview {
        width: 60px;
        height: 40px;
        object-fit: contain;
        margin-bottom: 8px;
        filter: drop-shadow(0 0 5px rgba(255,255,255,0.3));
    }

    .car-name {
        font-size: 11px;
        font-weight: bold;
        margin-bottom: 5px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .car-simple-stats {
        font-size: 10px;
        color: #aaa;
        margin-top: 5px;
        text-align: center;
    }

    .car-unlock-req {
        font-size: 8px;
        color: var(--neon-yellow);
        margin-top: 5px;
        font-style: italic;
    }

    .car-nav {
        display: flex;
        gap: 10px;
        margin-top: 20px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
    }

    .nav-btn {
        background: rgba(255,255,255,0.1);
        border: none;
        color: white;
        width: 35px;
        height: 35px;
        border-radius: 50%;
        cursor: pointer;
        font-size: 16px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s;
        flex-shrink: 0;
    }

    .nav-btn:hover { background: rgba(255,255,255,0.2); transform: scale(1.1); }

    .car-preview-container {
        width: 180px;
        height: 100px;
        background: rgba(20, 20, 20, 0.5);
        border-radius: 8px;
        margin: 15px 0;
        display: flex;
        align-items: center;
        justify-content: center;
        border: 2px solid rgba(255,255,255,0.1);
        box-sizing: border-box;
    }

    .selected-car-preview {
        width: 140px;
        height: 80px;
        object-fit: contain;
        filter: drop-shadow(0 0 10px rgba(255,255,255,0.5));
    }

    #installBtn {
        display: none;
        position: absolute;
        bottom: 20px;
        right: 20px;
        background: var(--neon-yellow);
        color: black;
        border: none;
        padding: 10px 15px;
        border-radius: 5px;
        font-weight: bold;
        cursor: pointer;
        z-index: 1000;
        font-size: clamp(12px, 3vw, 14px);
    }

    #fpsCounter {
        position: absolute;
        bottom: 15px;
        left: 15px;
        color: #00ff00;
        font-size: 12px;
        font-family: monospace;
        z-index: 30;
        display: none;
    }

    #orientationWarning {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        z-index: 1000;
        color: white;
        justify-content: center;
        align-items: center;
        text-align: center;
        padding: 20px;
        box-sizing: border-box;
    }
    
    .orientation-content {
        max-width: 400px;
        padding: 30px;
        background: rgba(10, 10, 10, 0.9);
        border-radius: 10px;
        border: 2px solid var(--neon-red);
    }
    
    .orientation-content h2 {
        color: var(--neon-red);
        margin-bottom: 20px;
    }
    
    @supports (padding: max(0px)) {
        #hud, #pauseBtn, .bg-pause-indicator {
            padding-left: max(15px, env(safe-area-inset-left));
            padding-right: max(15px, env(safe-area-inset-right));
            padding-top: max(15px, env(safe-area-inset-top));
        }
        
        .btn-pro { margin-bottom: max(10px, env(safe-area-inset-bottom)); }
    }

  </style>
</head>
<body>
    <div id="orientationWarning">
        <div class="orientation-content">
            <h2>üì± Please Rotate Device</h2>
            <p>For the best experience, please rotate your device to landscape mode.</p>
            <p>Road Rage 2D is designed to be played in landscape orientation.</p>
        </div>
    </div>
    
    <div id="fpsCounter">FPS: 60</div>
    
    <button id="installBtn" onclick="installGame()">üì≤ Install Game</button>
    
    <div id="gameContainer">
        <canvas id="game"></canvas>
        
        <div id="hud">
            <div class="stat-box">
                <div id="bestText">Top Record: 0</div>
                <div id="scoreText">0</div>
            </div>
            <div id="powerContainer">
                <div id="powerText"></div>
                <div id="powerBar">
                    <div id="powerFill"></div>
                </div>
            </div>
        </div>
        
        <div class="top-message" id="topMessage"></div>
        
        <div class="bg-pause-indicator" id="bgPauseIndicator">Auto Pause</div>
        
        <button id="pauseBtn" onclick="togglePause()">
            <svg class="pause-icon" viewBox="0 0 24 24" fill="currentColor">
                <rect x="6" y="4" width="4" height="16"></rect>
                <rect x="14" y="4" width="4" height="16"></rect>
            </svg>
            <svg class="play-icon" viewBox="0 0 24 24" fill="currentColor">
                <polygon points="5,3 19,12 5,21"></polygon>
            </svg>
        </button>
        
        <div id="pauseMenu">
            <div class="pause-title">PAUSED</div>
            <button class="btn-pro" onclick="resumeGame()">RESUME</button>
            <button class="btn-pro" style="margin-top: 20px; background: rgba(255,255,255,0.1); color: white;" onclick="restartGame()">RESTART</button>
            <button class="btn-pro" style="margin-top: 20px; background: var(--neon-red);" onclick="quitToMenu()">QUIT</button>
        </div>
        
        <div id="countdownOverlay">
            <div class="countdown-number">3</div>
            <div class="countdown-message">Get Ready!</div>
        </div>
        
        <div id="carSelectBox">
            <div class="car-select-title">SELECT YOUR RIDE</div>
            <div class="car-select-subtitle">Choose your vehicle and dominate the highway</div>
            
            <div class="car-preview-container">
                <img id="selectedCarPreview" class="selected-car-preview" src="" alt="Selected Car">
            </div>
            
            <div class="car-grid" id="carGrid"></div>
            
            <div class="car-nav">
                <button class="nav-btn" onclick="prevCarPage()">‚ùÆ</button>
                <button class="btn-pro" onclick="confirmCarSelection()" style="width: 180px;">SELECT & PLAY</button>
                <button class="nav-btn" onclick="nextCarPage()">‚ùØ</button>
            </div>
            
            <button class="btn-pro" style="margin-top: 15px; background: rgba(255,255,255,0.05);" onclick="backToMenu()">BACK TO MENU</button>
        </div>
        
        <div id="startBox" class="overlay">
            <h1>ROAD<br><span style="color:var(--neon-yellow)">RAGE 2D</span></h1>
            <p>Master the highway. Avoid traffic.<br>Use power-ups to survive.</p>
            <button class="btn-pro" onclick="showCarSelection()">SELECT CAR</button>
            <button class="btn-pro" style="margin-top: 15px; background: rgba(255,255,255,0.05);" onclick="quickStart()">QUICK START</button>
        </div>
        
        <div id="gameOverBox" class="overlay">
            <h1 style="color: var(--neon-red)">WASTED</h1>
            <div class="final-score-label">Distance Reached</div>
            <div id="finalScore" class="final-score-val">0</div>
            <button class="btn-pro blink" onclick="showCarSelection()">PLAY AGAIN</button>
            <button class="btn-pro" style="margin-top: 15px; background: rgba(255,255,255,0.05);" onclick="backToMenuFromGameOver()">MAIN MENU</button>
        </div>
    </div>
    
    <script>
    // ===== PWA & SERVICE WORKER =====
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./service-worker.js')
                .then(registration => {
                    console.log('‚úÖ Service Worker registered:', registration.scope);
                    
                    // Check cache status
                    setTimeout(() => {
                        if (registration.active) {
                            registration.active.postMessage({ type: 'CHECK_CACHE' });
                        }
                    }, 2000);
                    
                    // Listen for cache status
                    navigator.serviceWorker.addEventListener('message', event => {
                        if (event.data && event.data.type === 'CACHE_STATUS') {
                            console.log('üì¶ Cache Status:', event.data.data);
                            const cacheInfo = event.data.data;
                            if (cacheInfo.images >= 9 && cacheInfo.music >= 5) {
                                showTopMessage('‚úÖ Game ready for offline play!');
                            }
                        }
                    });
                })
                .catch(err => {
                    console.log('‚ùå Service Worker registration failed:', err);
                });
        });
    }
    
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        const installBtn = document.getElementById('installBtn');
        if (installBtn) {
            installBtn.style.display = 'block';
            setTimeout(() => { installBtn.style.display = 'none'; }, 30000);
        }
    });
    
    function installGame() {
        if (!deferredPrompt) {
            alert("Installation not available or already installed");
            return;
        }
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then(choiceResult => {
            if (choiceResult.outcome === 'accepted') {
                console.log('User installed Road Rage 2D');
                showTopMessage('‚úÖ Game Installed! Launch from home screen anytime.');
            }
            deferredPrompt = null;
            const installBtn = document.getElementById('installBtn');
            if (installBtn) installBtn.style.display = 'none';
        });
    }
    
    // ===== SCREEN ADAPTATION =====
    let GAME_WIDTH = 500;
    let GAME_HEIGHT = 800;
    let canvasWidth, canvasHeight;
    let scaleX, scaleY;
    let offsetX, offsetY;
    
    // ===== PERFORMANCE =====
    let lastTime = 0;
    let fps = 60;
    let frameCount = 0;
    let lastFpsUpdate = 0;
    const targetFPS = 60;
    
    // ===== DOM ELEMENTS =====
    const canvas = document.getElementById("game");
    const gameContainer = document.getElementById("gameContainer");
    const ctx = canvas.getContext("2d", { 
        willReadFrequently: false,
        alpha: true,
        desynchronized: true
    });
    
    ctx.imageSmoothingEnabled = true;
    ctx.imageSmoothingQuality = 'medium';
    
    const scoreText = document.getElementById("scoreText");
    const bestText = document.getElementById("bestText");
    const powerFill = document.getElementById("powerFill");
    const powerText = document.getElementById("powerText");
    const startBox = document.getElementById("startBox");
    const gameOverBox = document.getElementById("gameOverBox");
    const finalScore = document.getElementById("finalScore");
    const pauseBtn = document.getElementById("pauseBtn");
    const pauseMenu = document.getElementById("pauseMenu");
    const countdownOverlay = document.getElementById("countdownOverlay");
    const countdownNumber = countdownOverlay.querySelector('.countdown-number');
    const bgPauseIndicator = document.getElementById("bgPauseIndicator");
    const topMessage = document.getElementById("topMessage");
    const carSelectBox = document.getElementById("carSelectBox");
    const carGrid = document.getElementById("carGrid");
    const selectedCarPreview = document.getElementById("selectedCarPreview");
    const fpsCounter = document.getElementById("fpsCounter");
    const orientationWarning = document.getElementById("orientationWarning");
    
    // ===== GAME VARIABLES =====
    let highScore = Number(localStorage.getItem("rr_high_pro")) || 0;
    bestText.textContent = "Top Record: " + highScore;
    
    let car, enemies, roadLines, sideMarkers, speed, distance, score;
    let gameStarted = false, gameOver = false, moveDir = 0, spawnTimer = 0;
    let powerState = null, powerTimer = 0, powerCooldown = 0, nextPowerScore = 500;
    let scoreMultiplier = 1, powerMsg = "", powerMsgTimer = 0;
    let baseDistance = 0;
    let slowMultiplier = 1;
    let originalSpeed = 4;
    let scoreDuring2X = 0;
    let gamePaused = false;
    let isCountdown = false;
    let autoPaused = false;
    let messageTimer = 0;
    let lastMessageTime = 0;
    let selectedCarIndex = 0;
    let currentCarPage = 0;
    let unlockedCars = [0];
    
    let inputDir = 0;
    let playerImg, enemyImgs;
    
    // ===== SCREEN FUNCTIONS =====
    function resizeGame() {
        const containerWidth = gameContainer.clientWidth;
        const containerHeight = gameContainer.clientHeight;
        
        const gameAspect = GAME_WIDTH / GAME_HEIGHT;
        const containerAspect = containerWidth / containerHeight;
        
        if (containerAspect > gameAspect) {
            canvasHeight = containerHeight;
            canvasWidth = canvasHeight * gameAspect;
            offsetX = (containerWidth - canvasWidth) / 2;
            offsetY = 0;
        } else {
            canvasWidth = containerWidth;
            canvasHeight = canvasWidth / gameAspect;
            offsetX = 0;
            offsetY = (containerHeight - canvasHeight) / 2;
        }
        
        canvas.width = canvasWidth;
        canvas.height = canvasHeight;
        canvas.style.width = canvasWidth + 'px';
        canvas.style.height = canvasHeight + 'px';
        canvas.style.left = offsetX + 'px';
        canvas.style.top = offsetY + 'px';
        
        scaleX = canvasWidth / GAME_WIDTH;
        scaleY = canvasHeight / GAME_HEIGHT;
        adjustGameElements();
    }
    
    function adjustGameElements() {
        LANES[0] = 85 * scaleX;
        LANES[1] = 165 * scaleX;
        LANES[2] = 245 * scaleX;
        LANES[3] = 325 * scaleX;
        LANES[4] = 405 * scaleX;
        
        if (gameStarted && car) {
            car.x = Math.max(60 * scaleX, Math.min(car.x, 440 * scaleX - car.w));
            car.y = GAME_HEIGHT * scaleY - 150 * scaleY;
        }
    }
    
    const LANES = [85, 165, 245, 325, 405];
    
    // ===== INPUT HANDLING =====
    function getTouchPosition(clientX, clientY) {
        const rect = canvas.getBoundingClientRect();
        const x = clientX - rect.left;
        const y = clientY - rect.top;
        return { x: x / scaleX, y: y / scaleY };
    }
    
    window.addEventListener("keydown", e => {
        if (e.key === "ArrowLeft" || e.key === "a") inputDir = -1;
        if (e.key === "ArrowRight" || e.key === "d") inputDir = 1;
        if (e.key === "Escape" || e.key === "p") togglePause();
    });
    
    window.addEventListener("keyup", e => {
        if (e.key === "ArrowLeft" || e.key === "a" || e.key === "ArrowRight" || e.key === "d") {
            inputDir = 0;
        }
    });
    
    canvas.addEventListener("touchstart", e => {
        e.preventDefault();
        const touch = getTouchPosition(e.touches[0].clientX, e.touches[0].clientY);
        inputDir = touch.x < GAME_WIDTH / 2 ? -1 : 1;
    }, { passive: false });
    
    canvas.addEventListener("touchend", () => inputDir = 0, { passive: false });
    
    canvas.addEventListener("mousedown", e => {
        const pos = getTouchPosition(e.clientX, e.clientY);
        inputDir = pos.x < GAME_WIDTH / 2 ? -1 : 1;
    });
    
    window.addEventListener("mouseup", () => inputDir = 0);
    
    // ===== IMAGE PRELOADING =====
    function preloadImages(srcArray, callback) {
        let loaded = 0;
        const images = [];
        srcArray.forEach(src => {
            const img = new Image();
            img.src = src;
            img.onload = () => {
                loaded++;
                if (loaded === srcArray.length) callback(images);
            };
            img.onerror = () => {
                console.warn(`Failed to load image: ${src}`);
                loaded++;
                if (loaded === srcArray.length) callback(images);
            };
            images.push(img);
        });
    }
    
    const imageSources = [
        "./imahe/image2.png", 
        "./imahe/image1.png",
        "./imahe/image3.png",
        "./imahe/image4.png",
        "./imahe/image5.png",
        "./imahe/image6.png",
        "./imahe/image7.png",
        "./imahe/image8.png",
        "./imahe/image9.png"
    ];
    
    // ===== CAR DATABASE =====
    const carDatabase = [
        {
            name: "Street Racer",
            image: "./imahe/image2.png",
            speed: 7,
            handling: 8,
            acceleration: 9,
            description: "Balanced performance",
            unlocked: true,
            unlockRequirement: "Starting Car"
        },
        {
            name: "Speed Demon",
            image: "./imahe/image1.png",
            speed: 9,
            handling: 6,
            acceleration: 8,
            description: "Extreme top speed",
            unlocked: false,
            unlockRequirement: "Reach 2000 points"
        },
        {
            name: "Drift King",
            image: "./imahe/image3.png",
            speed: 6,
            handling: 10,
            acceleration: 7,
            description: "Perfect control",
            unlocked: false,
            unlockRequirement: "Reach 3000 points"
        },
        {
            name: "Muscle Car",
            image: "./imahe/image4.png",
            speed: 8,
            handling: 5,
            acceleration: 10,
            description: "Rapid acceleration",
            unlocked: false,
            unlockRequirement: "Reach 4000 points"
        },
        {
            name: "Sports Classic",
            image: "./imahe/image5.png",
            speed: 7,
            handling: 9,
            acceleration: 6,
            description: "Vintage style",
            unlocked: false,
            unlockRequirement: "Reach 5000 points"
        },
        {
            name: "Hyper Car",
            image: "./imahe/image6.png",
            speed: 10,
            handling: 7,
            acceleration: 9,
            description: "Ultimate performance",
            unlocked: false,
            unlockRequirement: "Reach 10000 points"
        },
        {
            name: "Cyber Racer",
            image: "./imahe/image7.png",
            speed: 8,
            handling: 8,
            acceleration: 8,
            description: "Futuristic tech",
            unlocked: false,
            unlockRequirement: "Beat high score"
        },
        {
            name: "Neon Cruiser",
            image: "./imahe/image8.png",
            speed: 6,
            handling: 9,
            acceleration: 7,
            description: "Glow in the dark",
            unlocked: false,
            unlockRequirement: "Play 10 games"
        },
        {
            name: "Monster Truck",
            image: "./imahe/image9.png",
            speed: 5,
            handling: 4,
            acceleration: 5,
            description: "Crush everything",
            unlocked: false,
            unlockRequirement: "Unlock all other cars"
        }
    ];
    
    // ===== MUSIC SYSTEM =====
    const bgTracks = [
        "./music/ms1.m4a",
        "./music/ms2.m4a",
        "./music/ms3.m4a",
        "./music/ms4.m4a",
        "./music/ms5.m4a"
    ];
    
    const bgAudios = bgTracks.map(src => {
        const a = new Audio(src);
        a.preload = "auto";
        a.volume = 0.5;
        a.setAttribute("playsinline", "");
        return a;
    });
    
    let currentBG = null;
    let lastIndex = -1;
    let musicEnabled = true;
    
    function playRandomBG() {
        if (!musicEnabled) return;
        
        let index;
        do {
            index = Math.floor(Math.random() * bgAudios.length);
        } while (index === lastIndex && bgAudios.length > 1);
        
        lastIndex = index;
        
        if (currentBG) {
            currentBG.pause();
            currentBG.currentTime = 0;
        }
        
        currentBG = bgAudios[index];
        const playPromise = currentBG.play();
        
        if (playPromise !== undefined) {
            playPromise.catch(e => {
                console.log("Audio play failed:", e);
                musicEnabled = false;
            });
        }
        
        currentBG.onended = playRandomBG;
    }
    
    function stopMusic() {
        if (currentBG) {
            currentBG.pause();
            currentBG.currentTime = 0;
        }
    }
    
    // ===== SIMPLE MESSAGES =====
    const simpleMessages = [
        "Miss mo na ba s'ya?",
        "What if mahal ka pa n'ya?",
        "I miss yoy",
        "Okay lang 'yan",
        "Kaya pa 'yan late game",
        "Balik ka na",
        "Don't give up!",
        "Sana ako na lang",
        "Mahal pa kita",
        "Akala mo mahal ka n'ya?",
        "Sana ikaw na lang no?",
        "Masarap ba na parang wala ka lang sa kanya?",
        "Kaya pa yan late game"
    ];
    
    function showTopMessage(message) {
        if (!gameStarted || gamePaused || isCountdown || gameOver) return;
        
        if (parseFloat(topMessage.style.opacity) > 0) return;
        
        topMessage.textContent = message;
        topMessage.style.opacity = "1";
        messageTimer = 120;
        lastMessageTime = score;
    }
    
    function updateTopMessage() {
        if (messageTimer > 0) {
            messageTimer--;
            if (messageTimer <= 40) {
                topMessage.style.opacity = (messageTimer / 40).toString();
            }
        }
    }
    
    function showRandomMessage() {
        if (!gameStarted || gamePaused || isCountdown || gameOver) return;
        if (parseFloat(topMessage.style.opacity) > 0) return;
        
        if (score - lastMessageTime > 500 && Math.random() < 0.002) {
            const randomIndex = Math.floor(Math.random() * simpleMessages.length);
            showTopMessage(simpleMessages[randomIndex]);
        }
        
        if (score > 0 && score % 1000 === 0 && score - lastMessageTime > 300) {
            showTopMessage(`${score} points! Awesome!`);
        }
        
        if (highScore > 0 && score > highScore - 200 && score < highScore) {
            if (score - lastMessageTime > 400) {
                showTopMessage("Almost beat your record!");
            }
        }
        
        if (powerMsgTimer === 59) {
            if (score - lastMessageTime > 300) {
                showTopMessage(" what if mahal ka pa n'ya? Power up boi!");
            }
        }
    }
    
    // ===== GAME INITIALIZATION =====
    function initGame() {
        car = { 
            x: 230 * scaleX,
            y: GAME_HEIGHT * scaleY - 150 * scaleY,
            w: 50 * scaleX,
            h: 90 * scaleY,
            img: playerImg,
            shield: false
        };
        
        enemies = [];
        roadLines = [];
        sideMarkers = [];
        speed = 4;
        distance = 0;
        score = 0;
        spawnTimer = 0;
        powerState = null;
        powerTimer = 0;
        powerCooldown = 0;
        nextPowerScore = 500;
        scoreMultiplier = 1;
        slowMultiplier = 1;
        originalSpeed = 4;
        powerMsg = "";
        powerMsgTimer = 0;
        gameOver = false;
        baseDistance = 0;
        scoreDuring2X = 0;
        gamePaused = false;
        isCountdown = false;
        autoPaused = false;
        messageTimer = 0;
        lastMessageTime = 0;
        
        powerText.textContent = "";
        powerFill.style.width = "0%";
        powerFill.style.background = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();
        
        pauseMenu.style.display = "none";
        countdownOverlay.style.display = "none";
        bgPauseIndicator.style.display = "none";
        pauseBtn.style.display = "none";
        pauseBtn.classList.remove("paused");
        topMessage.style.opacity = "0";
        
        for (let i = 0; i < GAME_HEIGHT; i += 80) {
            roadLines.push({ y: i * scaleY });
            sideMarkers.push({ y: i * scaleY });
        }
        
        lastTime = 0;
        fps = 60;
        frameCount = 0;
        lastFpsUpdate = 0;
    }
    
    // ===== GAME START =====
    function startGame() {
        startBox.style.display = "none";
        gameOverBox.style.display = "none";
        carSelectBox.style.display = "none";
        initGame();
        gameStarted = true;
        pauseBtn.style.display = "flex";
        pauseBtn.classList.remove("paused");
        
        fpsCounter.style.display = 'none';
        
        try {
            playRandomBG();
        } catch (e) {
            console.log("Music play failed:", e);
            musicEnabled = false;
        }
        
        requestAnimationFrame(gameLoop);
    }
    
    // ===== COLLISION DETECTION =====
    function hit(a, b) {
        return a.x < b.x + b.w && 
               a.x + a.w > b.x && 
               a.y < b.y + b.h && 
               a.y + a.h > b.y;
    }
    
    // ===== ENEMY SPAWNING =====
    function spawnEnemies() {
        let lanes = [...LANES];
        let count = Math.random() < 0.75 ? 1 : 2;
        
        for (let i = 0; i < count; i++) {
            if (lanes.length === 0) break;
            let idx = Math.floor(Math.random() * lanes.length);
            enemies.push({ 
                x: lanes.splice(idx, 1)[0],
                y: -120 * scaleY,
                w: 50 * scaleX,
                h: 90 * scaleY,
                img: enemyImgs[Math.floor(Math.random() * enemyImgs.length)]
            });
        }
    }
    
    // ===== DRAWING FUNCTIONS =====
    function drawPlayer(c) {
        ctx.save();
        ctx.shadowColor = "rgba(255,255,255,0.35)";
        ctx.shadowBlur = 18;
        
        if (c.img && c.img.complete) {
            ctx.drawImage(c.img, c.x, c.y, c.w, c.h);
        } else {
            ctx.fillStyle = "#00ff00";
            ctx.fillRect(c.x, c.y, c.w, c.h);
        }
        ctx.restore();
    }
    
    function drawEnemy(e) {
        if (e.img && e.img.complete) {
            ctx.drawImage(e.img, e.x, e.y, e.w, e.h);
        } else {
            ctx.fillStyle = "#ff0000";
            ctx.fillRect(e.x, e.y, e.w, e.h);
        }
    }
    
    function drawAllEnemies() {
        enemies.forEach(e => { drawEnemy(e); });
    }
    
    function drawRoad() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        ctx.fillStyle = "#141414";
        ctx.fillRect(50 * scaleX, 0, 400 * scaleX, canvas.height);
        
        roadLines.forEach(l => {
            l.y += speed * scaleY;
            if (l.y > canvas.height) l.y = -80 * scaleY;
            ctx.fillStyle = "#bbb";
            ctx.fillRect(canvas.width/2 - 5 * scaleX, l.y, 10 * scaleX, 40 * scaleY);
        });
        
        sideMarkers.forEach(s => {
            s.y += speed * scaleY;
            if (s.y > canvas.height) s.y = -80 * scaleY;
            ctx.fillStyle = "#444";
            ctx.fillRect(50 * scaleX, s.y, 2 * scaleX, 40 * scaleY);
            ctx.fillRect(448 * scaleX, s.y, 2 * scaleX, 40 * scaleY);
        });
        
        ctx.fillStyle = "rgba(255,255,255,0.08)";
        ctx.fillRect(50 * scaleX, 0, 400 * scaleX, canvas.height);
    }
    
    function drawPowerEffects() {
        if (!powerState) return;
        
        if (powerState === "SHIELD") {
            ctx.save();
            ctx.strokeStyle = car.shield ? "rgba(0, 255, 255, 0.7)" : "rgba(255, 100, 100, 0.5)";
            ctx.lineWidth = 4 * scaleX;
            ctx.shadowColor = car.shield ? "#00ffff" : "#ff6464";
            ctx.shadowBlur = car.shield ? 15 * scaleX : 8 * scaleX;
            ctx.strokeRect(car.x - 6 * scaleX, car.y - 6 * scaleY, car.w + 12 * scaleX, car.h + 12 * scaleY);
            ctx.restore();
        }
    }
    
    // ===== POWER-UP SYSTEM =====
    function activatePower() {
        const powers = ["SHIELD", "SLOW", "2X"];
        powerState = powers[Math.floor(Math.random() * 3)];
        powerTimer = 300;
        powerCooldown = 900;
        powerText.textContent = "POWER: " + powerState;
        powerMsg = powerState + " POWER!";
        powerMsgTimer = 60;
        
        if (powerState === "SHIELD") car.shield = true;
        if (powerState === "SLOW") { slowMultiplier = 0.6; originalSpeed = speed; }
        if (powerState === "2X") { scoreMultiplier = 2; baseDistance = distance; scoreDuring2X = score; }
    }
    
    // ===== CAR SELECTION SYSTEM =====
    function showCarSelection() {
        startBox.style.display = "none";
        gameOverBox.style.display = "none";
        updateUnlockedCars();
        renderCarSelection();
        carSelectBox.style.display = "flex";
    }
    
    function updateUnlockedCars() {
        const savedUnlocked = localStorage.getItem("rr_unlocked_cars");
        if (savedUnlocked) {
            unlockedCars = JSON.parse(savedUnlocked);
        } else {
            unlockedCars = [0];
            localStorage.setItem("rr_unlocked_cars", JSON.stringify(unlockedCars));
        }
        
        const checkpoints = [2000, 3000, 4000, 5000, 10000];
        checkpoints.forEach((checkpoint, index) => {
            if (highScore >= checkpoint && !unlockedCars.includes(index + 1)) {
                unlockedCars.push(index + 1);
            }
        });
        
        localStorage.setItem("rr_unlocked_cars", JSON.stringify(unlockedCars));
        
        carDatabase.forEach((car, index) => {
            car.unlocked = unlockedCars.includes(index);
        });
    }
    
    function renderCarSelection() {
        carGrid.innerHTML = '';
        const carsPerPage = 6;
        const startIndex = currentCarPage * carsPerPage;
        const endIndex = Math.min(startIndex + carsPerPage, carDatabase.length);
        
        for (let i = startIndex; i < endIndex; i++) {
            const carData = carDatabase[i];
            const carOption = document.createElement('div');
            carOption.className = `car-option ${carData.unlocked ? '' : 'locked'} ${i === selectedCarIndex ? 'selected' : ''}`;
            carOption.onclick = () => selectCar(i);
            
            carOption.innerHTML = `
                <img src="${carData.image}" class="car-preview" alt="${carData.name}" loading="lazy">
                <div class="car-name">${carData.name}</div>
                <div class="car-simple-stats">
                    Speed: ${carData.speed}/10<br>
                    ${carData.description}
                </div>
                ${!carData.unlocked ? `<div class="car-unlock-req">${carData.unlockRequirement}</div>` : ''}
            `;
            
            carGrid.appendChild(carOption);
        }
        
        const selectedCar = carDatabase[selectedCarIndex];
        selectedCarPreview.src = selectedCar.image;
    }
    
    function selectCar(index) {
        const carData = carDatabase[index];
        if (!carData.unlocked) {
            showTopMessage("Locked! " + carData.unlockRequirement);
            return;
        }
        selectedCarIndex = index;
        renderCarSelection();
    }
    
    function prevCarPage() {
        if (currentCarPage > 0) {
            currentCarPage--;
            renderCarSelection();
        }
    }
    
    function nextCarPage() {
        const totalPages = Math.ceil(carDatabase.length / 6);
        if (currentCarPage < totalPages - 1) {
            currentCarPage++;
            renderCarSelection();
        }
    }
    
    function confirmCarSelection() {
        const selectedCar = carDatabase[selectedCarIndex];
        if (!selectedCar.unlocked) {
            showTopMessage("This car is locked!");
            return;
        }
        
        const img = new Image();
        img.src = selectedCar.image;
        img.onload = () => {
            playerImg = img;
            startGame();
        };
        img.onerror = () => { startGame(); };
    }
    
    function quickStart() {
        selectedCarIndex = 0;
        const img = new Image();
        img.src = carDatabase[0].image;
        img.onload = () => {
            playerImg = img;
            startGame();
        };
        img.onerror = () => { startGame(); };
    }
    
    function backToMenu() {
        carSelectBox.style.display = "none";
        startBox.style.display = "flex";
    }
    
    function backToMenuFromGameOver() {
        gameOverBox.style.display = "none";
        startBox.style.display = "flex";
    }
    
    // ===== PAUSE/RESUME SYSTEM =====
    function togglePause() {
        if (!gameStarted || gameOver || isCountdown) return;
        if (!gamePaused) { pauseGame(false); } else { resumeGame(); }
    }
    
    function pauseGame(isAutoPause) {
        if (gamePaused || !gameStarted || gameOver || isCountdown) return;
        
        gamePaused = true;
        autoPaused = isAutoPause;
        
        if (isAutoPause) {
            bgPauseIndicator.style.display = "block";
            pauseBtn.classList.add("paused");
        } else {
            pauseMenu.style.display = "flex";
            pauseBtn.classList.add("paused");
            bgPauseIndicator.style.display = "none";
        }
        
        if (currentBG) currentBG.pause();
        topMessage.style.opacity = "0";
    }
    
    function resumeGame() {
        if (!gamePaused) return;
        pauseMenu.style.display = "none";
        bgPauseIndicator.style.display = "none";
        startCountdown();
    }
    
    function startCountdown() {
        isCountdown = true;
        countdownOverlay.style.display = "flex";
        
        let count = 3;
        countdownNumber.textContent = count;
        
        const countdownInterval = setInterval(() => {
            count--;
            if (count > 0) {
                countdownNumber.textContent = count;
            } else {
                countdownNumber.textContent = "GO!";
                setTimeout(() => {
                    clearInterval(countdownInterval);
                    countdownOverlay.style.display = "none";
                    gamePaused = false;
                    isCountdown = false;
                    autoPaused = false;
                    pauseBtn.classList.remove("paused");
                    
                    if (currentBG && musicEnabled) {
                        currentBG.play().catch(() => { musicEnabled = false; });
                    }
                }, 1000);
            }
        }, 1000);
    }
    
    function restartGame() {
        pauseMenu.style.display = "none";
        bgPauseIndicator.style.display = "none";
        gamePaused = false;
        autoPaused = false;
        pauseBtn.classList.remove("paused");
        
        const img = new Image();
        img.src = carDatabase[selectedCarIndex].image;
        img.onload = () => { playerImg = img; startGame(); };
        img.onerror = () => { startGame(); };
    }
    
    function quitToMenu() {
        pauseMenu.style.display = "none";
        bgPauseIndicator.style.display = "none";
        gamePaused = false;
        gameStarted = false;
        autoPaused = false;
        pauseBtn.style.display = "none";
        pauseBtn.classList.remove("paused");
        
        showCarSelection();
        stopMusic();
    }
    
    // ===== ORIENTATION HANDLING =====
    function checkOrientation() {
        const isPortrait = window.innerHeight > window.innerWidth;
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        
        if (isMobile && isPortrait) {
            orientationWarning.style.display = 'flex';
            return false;
        } else {
            orientationWarning.style.display = 'none';
            return true;
        }
    }
    
    // ===== MAIN GAME LOOP =====
    function gameLoop(timestamp) {
        frameCount++;
        if (timestamp >= lastFpsUpdate + 1000) {
            fps = frameCount;
            frameCount = 0;
            lastFpsUpdate = timestamp;
            fpsCounter.textContent = `FPS: ${fps}`;
        }
        
        drawRoad();
        
        if (gameStarted && !gameOver && !gamePaused && !isCountdown) {
            updateTopMessage();
            showRandomMessage();
            
            if (powerTimer > 0) {
                powerTimer--;
                powerFill.style.width = (powerTimer / 300 * 100) + "%";
                powerFill.style.background = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();
                
                if (powerTimer <= 0) {
                    if (powerState === "SHIELD") car.shield = false;
                    if (powerState === "SLOW") slowMultiplier = 1;
                    if (powerState === "2X") { 
                        scoreMultiplier = 1; 
                        if (score > distance) distance = score; 
                    }
                    
                    powerState = null;
                    powerText.textContent = "";
                    powerFill.style.width = "0%";
                    powerFill.style.background = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();
                }
            }
            
            if (powerState === null && powerCooldown > 0) {
                powerCooldown--;
                let cooldownPercent = Math.max(0, ((900 - powerCooldown) / 900) * 100);
                powerFill.style.width = cooldownPercent + "%";
                powerFill.style.background = "#666";
                
                if (powerCooldown <= 0) {
                    powerFill.style.width = "0%";
                    powerFill.style.background = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();
                }
            }
            
            const moveSpeed = 7 * scaleX;
            car.x += inputDir * moveSpeed;
            car.x = Math.max(60 * scaleX, Math.min(car.x, 440 * scaleX - car.w));
            
            let distanceGained = speed / 12;
            distance += distanceGained;
            
            if (powerState === "2X") {
                let newDistance = distance - baseDistance;
                score = Math.floor(baseDistance + (newDistance * 2));
            } else {
                score = Math.max(score, Math.floor(distance));
            }
            
            scoreText.textContent = score;
            
            let level = Math.floor(score / 1000);
            let baseSpeed = 4;
            let levelSpeed = level * 0.6;
            let smoothSpeed = distance / 600;
            let calculatedSpeed = Math.min(10, baseSpeed + levelSpeed + smoothSpeed);
            
            const selectedCar = carDatabase[selectedCarIndex];
            let carSpeedBonus = (selectedCar.speed - 7) * 0.1;
            let carHandlingBonus = (selectedCar.handling - 8) * 0.05;
            
            if (powerState === "SLOW" && powerTimer > 0) {
                speed = calculatedSpeed * slowMultiplier * (1 + carSpeedBonus);
            } else {
                speed = calculatedSpeed * (1 + carSpeedBonus);
            }
            
            car.x += inputDir * (moveSpeed + carHandlingBonus * 2 * scaleX);
            
            if (score >= nextPowerScore && powerState === null && powerCooldown <= 0) {
                activatePower();
                nextPowerScore = score + 400;
            }
            
            spawnTimer++;
            
            if (spawnTimer > Math.max(80, 140 - distance / 10)) {
                spawnEnemies();
                spawnTimer = 0;
            }
            
            enemies.forEach((e, i) => {
                e.y += speed * scaleY;
                
                if (hit(car, e)) {
                    if (powerState === "SHIELD" && car.shield && powerTimer > 0) {
                        e.y = canvas.height + 200 * scaleY;
                        powerTimer = Math.max(0, powerTimer - 50);
                        car.shield = false;
                        powerText.textContent = "POWER: SHIELD (USED)";
                    } else {
                        gameOver = true;
                        stopMusic();
                        
                        if (score > highScore) {
                            highScore = score;
                            localStorage.setItem("rr_high_pro", score);
                            bestText.textContent = "Top Record: " + score;
                        }
                        
                        updateUnlockedCars();
                        finalScore.textContent = score;
                        gameOverBox.style.display = "flex";
                        pauseBtn.style.display = "none";
                        bgPauseIndicator.style.display = "none";
                    }
                }
            });
            
            enemies = enemies.filter(e => e.y < canvas.height + 120 * scaleY);
            
            drawAllEnemies();
            drawPlayer(car);
            drawPowerEffects();
            
            if (powerMsgTimer > 0) {
                ctx.save();
                ctx.globalAlpha = powerMsgTimer / 60;
                ctx.fillStyle = "#00ffff";
                ctx.font = `${28 * scaleX}px Courier`;
                ctx.textAlign = "center";
                ctx.fillText(powerMsg, canvas.width / 2, canvas.height / 2 - 40 * scaleY);
                ctx.restore();
                powerMsgTimer--;
            }
            
            ctx.save();
            ctx.globalAlpha = 0.5;
            ctx.fillStyle = "#fff";
            ctx.font = `${12 * scaleX}px sans-serif`;
            ctx.textAlign = "left";
            ctx.fillText(`Speed: ${speed.toFixed(1)} | Car: ${carDatabase[selectedCarIndex].name}`, 20 * scaleX, canvas.height - 20 * scaleY);
            ctx.restore();
        } else if (!gameOver) {
            powerText.textContent = "";
            powerFill.style.width = "0%";
            powerFill.style.background = getComputedStyle(document.documentElement).getPropertyValue('--neon-blue').trim();
        }
        
        requestAnimationFrame(gameLoop);
    }
    
    // ===== PAGE VISIBILITY HANDLER =====
    function handleVisibilityChange() {
        if (document.hidden) {
            if (gameStarted && !gameOver && !gamePaused && !isCountdown) {
                pauseGame(true);
            }
            if (currentBG) {
                currentBG.pause();
            }
        }
    }
    
    document.addEventListener("visibilitychange", handleVisibilityChange);
    
    // ===== INITIALIZATION =====
    window.addEventListener('load', () => {
        checkOrientation();
        resizeGame();
        window.addEventListener('resize', resizeGame);
        window.addEventListener('orientationchange', () => {
            setTimeout(() => {
                checkOrientation();
                resizeGame();
            }, 300);
        });
        
        preloadImages(imageSources, (loadedImages) => {
            playerImg = loadedImages[0];
            enemyImgs = loadedImages.slice(1);
            console.log('‚úÖ Game assets loaded!');
            
            // Show PWA status
            if (navigator.onLine) {
                console.log('üåê Online - Game will cache for offline play');
            } else {
                console.log('‚ö´ Offline - Using cached version');
                showTopMessage('‚ö´ Playing offline - game cached!');
            }
        });
        
        document.addEventListener("touchmove", e => {
            if (gameStarted) { e.preventDefault(); }
        }, { passive: false });
    });
    
    // Clean up
    window.addEventListener("pagehide", stopMusic);
    window.addEventListener("beforeunload", stopMusic);
    
    // Offline/Online detection
    window.addEventListener('online', () => {
        console.log('üîµ Back online');
        showTopMessage('‚úÖ Back online - game synced');
    });
    
    window.addEventListener('offline', () => {
        console.log('‚ö´ Went offline');
        showTopMessage('‚ö´ Offline mode - all good!');
    });
    </script>
</body>
  </html>
